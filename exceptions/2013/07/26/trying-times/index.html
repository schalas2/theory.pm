
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Trying Times - theory.pm</title>
  <meta name="author" content="David E. Wheeler">

  
  <meta name="description" content="Exception handling is a bit of a pain in Perl. Traditionally, we use
eval {}: Perl eval1
2
3
4
5
6
eval { foo();
}
if (my $err = $@) { # Inspect $err &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://theory.pm/exceptions/2013/07/26/trying-times">
  <link href="/favicon.ico" rel="icon">
  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="theory.pm" type="application/atom+xml">
  

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-42757636-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   class="no-sidebar"  >
  <header role="banner"><hgroup>
  <h2><a href="/"><img src="/images/logo.png" alt="::" /></a></h2>
  <h1><a href="/">theory.pm</a></h1>
</hgroup>

</header>
  <nav role="navigation">
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:theory.pm" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives">Archives</a></li>
  <li><a href="https://metacpan.org/author/DWHEELER">CPAN</a></li>
  <li><a href="/about/">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>










<article class="hentry" role="article" >
  
  <header>
    <h1 class="entry-title">

Trying Times

</h1>

    
      <p class="meta">
        








  


<time datetime="2013-07-26T15:20:00-07:00" pubdate data-updated="true">Friday, 26 July 2013</time>
        
         &bull; <a rel="bookmark" href="/exceptions/2013/07/26/trying-times/">§</a>
      </p>
    
  </header>



  <div class="entry-content"><p>Exception handling is a bit of a pain in Perl. Traditionally, we use
<code>eval {}</code>:</p>

<figure class='code'><figcaption><span>Perl eval</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="nb">eval</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">foo</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="vg">$@</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1"># Inspect $err…</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The use of the <code>if</code> block is a bit unfortunate; worse is the use of the global
<code>$@</code> variable, which has inflicted unwarranted pain on developers over the
years<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>. Many Perl hackers put <a href="https://metacpan.org/module/Try::Tiny">Try::Tiny</a> to work to circumvent these
shortcomings:</p>

<figure class='code'><figcaption><span>Try::Tiny</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="n">try</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">foo</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span> <span class="n">catch</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1"># Inspect $_…</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Alas, Try::Tiny introduces its own idiosyncrasies, particularly its use of
subroutine references rather than blocks. While a necessity of a pure-Perl
implementation, it prevents <code>return</code>ing from the calling context. One must
work around this deficiency by <a href="http://stackoverflow.com/a/10366209/79202">checking return values</a>:</p>

<figure class='code'><figcaption><span>Return from Try::Tiny</span><a href='http://stackoverflow.com/a/10366209/79202'>More Gotchas</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">my</span> <span class="nv">$rv</span> <span class="o">=</span> <span class="n">try</span> <span class="p">{</span>
</span><span class='line'>   <span class="n">f</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span> <span class="n">catch</span> <span class="p">{</span>
</span><span class='line'>   <span class="c1"># …</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$rv</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I can&rsquo;t tell you how often this quirk burns me.</p>

<!-- more -->


<p>Sadly, there is a deeper problem then syntax: Just what, exactly, is an
exception? How does one determine the exceptional condition, and what can be
done about it? It might be a string. The string might be localized. It might
be an <a href="https://metacpan.org/module/Exception::Class">Exception::Class</a> object, or a <a href="https://metacpan.org/module/Throwable">Throwable</a> object, or a simple array
reference. Or any other value a Perl scalar can hold. This lack of specificity
requires careful handling of exceptions:</p>

<figure class='code'><figcaption><span>Exceptional Conditions</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="k">if</span> <span class="p">(</span><span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="vg">$@</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">ref</span> <span class="nv">$err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">eval</span> <span class="p">{</span> <span class="nv">$err</span><span class="o">-&gt;</span><span class="n">isa</span><span class="p">(</span><span class="s">&#39;Exception::Class&#39;</span><span class="p">)</span> <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span> <span class="nv">$err</span><span class="o">-&gt;</span><span class="n">isa</span><span class="p">(</span><span class="s">&#39;SomeException&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1"># …</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$err</span><span class="o">-&gt;</span><span class="n">isa</span><span class="p">(</span><span class="s">&#39;SomeException&#39;</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1"># …</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1"># …</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span><span class="nb">eval</span> <span class="p">{</span> <span class="nv">$err</span><span class="o">-&gt;</span><span class="n">DOES</span><span class="p">(</span><span class="s">&#39;Throwable&#39;</span><span class="p">)</span> <span class="p">})</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1"># …</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nb">ref</span> <span class="nv">$err</span> <span class="ow">eq</span> <span class="s">&#39;ARRAY&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1"># …</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span> <span class="nv">$err</span> <span class="o">=~</span><span class="sr"> /DBI/</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1"># …</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">elsif</span> <span class="p">(</span> <span class="nv">$err</span> <span class="o">=~</span><span class="sr"> /cannot open &#39;([^&#39;]+)&#39;/</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1"># …</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not every exception handler requires so many conditions, but I have certainly
exercised all these approaches. Usually my exception handlers accrete
condition as users report new, unexpected errors.</p>

<p>That&rsquo;s not all. My code frequently requires parsing information out of a
string error. Here&rsquo;s an example from <a href="https://github.com/pgxn/pgxn-manager/">PGXN::Manager</a>:</p>

<figure class='code'><figcaption><span>Exception Parsing</span><a href='https://github.com/pgxn/pgxn-manager/blob/master/lib/PGXN/Manager/Distribution.pm#L123'>Source</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='perl'><span class='line'><span class="n">try</span> <span class="p">{</span>
</span><span class='line'>    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">distmeta</span><span class="p">(</span><span class="n">decode_json</span> <span class="nb">scalar</span> <span class="nv">$member</span><span class="o">-&gt;</span><span class="n">contents</span> <span class="p">);</span>
</span><span class='line'><span class="p">}</span> <span class="n">catch</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">my</span> <span class="nv">$f</span> <span class="o">=</span> <span class="nb">quotemeta</span> <span class="n">__FILE__</span><span class="p">;</span>
</span><span class='line'>    <span class="p">(</span><span class="k">my</span> <span class="nv">$err</span> <span class="o">=</span> <span class="nv">$_</span><span class="p">)</span> <span class="o">=~</span> <span class="sr">s/\s+at\s+$f.+//ms</span><span class="p">;</span>
</span><span class='line'>    <span class="nv">$self</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">([</span>
</span><span class='line'>        <span class="s">&#39;Cannot parse JSON from “[_1]”: [_2]&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nv">$member</span><span class="o">-&gt;</span><span class="n">fileName</span><span class="p">,</span>
</span><span class='line'>        <span class="nv">$err</span>
</span><span class='line'>    <span class="p">]);</span>
</span><span class='line'>    <span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="ow">or</span> <span class="k">return</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nv">$self</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>When <a href="https://metacpan.org/module/JSON">JSON</a> throws an exception on invalid JSON, the code must catch that
exception to show the user. The user cares not at all what file threw the
exception, nor the line number. The code must <em>strip that stuff out</em> before
passing the original message off to a localizing error method.</p>

<p>Gross.</p>

<p>It&rsquo;s time to end this. A forthcoming post will propose a plan for adding
proper exception handling to the core Perl language, including exception
objects and an official <code>try</code>/<code>catch</code> syntax.</p>

<!-- notes -->




<div id='networkedblogs_nwidget_container' style='height:360px;padding-top:10px;'><div id='networkedblogs_nwidget_above'></div><div id='networkedblogs_nwidget_widget' style="border:1px solid #D1D7DF;background-color:#F5F6F9;margin:0px auto;"><div id="networkedblogs_nwidget_logo" style="padding:1px;margin:0px;background-color:#edeff4;text-align:center;height:21px;"><a href="http://www.networkedblogs.com/" target="_blank" title="NetworkedBlogs"><img style="border: none;" src="http://static.networkedblogs.com/static/images/logo_small.png" title="NetworkedBlogs"/></a></div><div id="networkedblogs_nwidget_body" style="text-align: center;"></div><div id="networkedblogs_nwidget_follow" style="padding:5px;"><a style="display:block;line-height:100%;width:90px;margin:0px auto;padding:4px 8px;text-align:center;background-color:#3b5998;border:1pxsolid #D9DFEA;border-bottom-color:#0e1f5b;border-right-color:#0e1f5b;color:#FFFFFF;font-family:'lucida grande',tahoma,verdana,arial,sans-serif;font-size:11px;text-decoration:none;" href="http://www.networkedblogs.com/blog/theorypm" id="ebac8e75be42e2bc9b4b710e6436008d">Follow this blog</a></div></div><div id='networkedblogs_nwidget_below'></div></div>


<script type="text/javascript">
if(typeof(networkedblogs)=="undefined"){networkedblogs={};networkedblogs.blogId=1391106;networkedblogs.shortName="theorypm";}
</script>


<script src="http://nwidget.networkedblogs.com/getnetworkwidget?bid=1391106" type="text/javascript"></script>

<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>In fairness much of the <code>$@</code> pain has been addressed [in Perl 5.14].<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>


  <footer>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://theory.pm/exceptions/2013/07/26/trying-times/" data-via="theory" data-counturl="http://theory.pm/exceptions/2013/07/26/trying-times/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="false" data-layout="button_count" data-width="200" data-show-faces="false"></div>
  
  
  <span class="adn-post"><a href="https://alpha.app.net/intent/post/?url=/exceptions/2013/07/26/trying-times/&text=theory.pm: “Trying Times”" class="adn-button" target="_blank" data-type="share" data-width="132" data-height="20" data-text="theory.pm: “Trying Times”" data-url="/exceptions/2013/07/26/trying-times/" >Share on App.net</a></span>
  <script>(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//d2zh9g63fcvyrq.cloudfront.net/adn.js";fjs.parentNode.insertBefore(js,fjs);}}(document, "script", "adn-button-js"));</script>
  
</div>

    
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn"><a href="/about" title="About the author (David E. Wheeler)" rel="author">David E. Wheeler</a></span></span>

      








  


<time datetime="2013-07-26T15:20:00-07:00" pubdate data-updated="true">Friday, 26 July 2013</time>
      

<span class="categories">
  
    <a class='category' href='/categories/exceptions/'>exceptions</a>
  
</span>


    </p>
          <div class="follow_buttons_byline">

  <a href="http://twitter.com/theory" class="twitter-follow-button" data-show-count="true">Follow @theory</a>


   <a href="https://alpha.app.net/intent/follow/?user_id=%40theory" class="adn-button" target="_blank" data-type="follow" data-width="277" data-height="20" data-user-id="@theory" data-show-count="1" data-show-username="1">Follow me on App.net</a>
<script src="//d2zh9g63fcvyrq.cloudfront.net/adn.js"></script>

      </div>

    <p class="meta">
      
      
        <a class="basic-alignment right" href="/blog/2013/07/26/a-perl-blog/" title="next Post: A Perl Blog">A Perl Blog &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 – David E. Wheeler –
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> –
  <a href="/atom.xml" title="Subscribe to theory.com">Feed</a>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'theorypm';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://theory.pm/exceptions/2013/07/26/trying-times/';
        var disqus_url = 'http://theory.pm/exceptions/2013/07/26/trying-times/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
